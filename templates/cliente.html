{% extends "base.html" %}
{% block content %}
<link href="/static/css/cliente.css" rel="stylesheet">

<a href="/" class="navbar-button">Regresar</a>

<div class="form-wrapper">
    <!-- Botón Guardar arriba derecha -->
    <div class="top-right-buttons">
        <button type="submit" form="clienteForm" class="btn btn-primary">Guardar datos</button>
    </div>

    <h2>{{ cliente.razon_social }}</h2>
    <p>Cliente cargado: {{ cliente.nit_cliente }}</p>

    <form id="clienteForm" method="post" action="/cliente/{{ cliente.id }}/update">
        <div class="form-grid">
            <!-- Columna 1 -->
            <div class="mb-2">
                <label>Razón social:</label>
                <input type="text" name="razon_social" value="{{ cliente.razon_social }}" readonly>
            </div>
            <div class="mb-2">
                <label>NIT cliente:</label>
                <input type="text" name="nit_cliente" value="{{ cliente.nit_cliente }}" readonly>
            </div>
            <div class="mb-2">
                <label>Nro. docto. cruce:</label>
                <input type="text" name="nro_docto_cruce" value="{{ cliente.nro_docto_cruce }}" readonly>
            </div>
            <div class="mb-2">
                <label>Fecha docto:</label>
                <input type="date" name="fecha_docto" value="{{ cliente.fecha_docto.strftime('%Y-%m-%d') if cliente.fecha_docto else '' }}" readonly>
            </div>

            <div class="mb-2">
                <label>Días vencidos:</label>
                <input type="number" name="dias_vencidos" value="{{ cliente.dias_vencidos }}" readonly>
            </div>

            <!-- Columna 2 -->
            <div class="mb-2">
                <label>Valor docto:</label>
                <input type="text" name="valor_docto" value="{{ '{:,}'.format(cliente.valor_docto|int) if cliente.valor_docto else '' }}" readonly>
            </div>

            <div class="mb-2">
                <label>Teléfono:</label>
                <input type="text" name="telefono" placeholder="Ingrese telefono" value="{{ cliente.telefono }}">
            </div>
            <div class="mb-2">
                <label>Fecha vcto:</label>
                <input type="date" name="fecha_vcto" value="{{ cliente.fecha_vcto }}" readonly>
            </div>
            <div class="mb-2">
                <label>Total COP:</label>
                <input type="text" name="total_cop"
                       value="{{ '{:,.0f}'.format(cliente.total_cop|float) if cliente.total_cop else '' }}">
            </div>
            <div class="mb-2">
                <label>Fecha gestión:</label>
                <input type="date" name="fecha_gestion" value="{{ cliente.fecha_gestion.strftime('%Y-%m-%d') if cliente.fecha_gestion else '' }}">
            </div>

            <!-- Columna 3 -->
            <div class="mb-2">
                <label>Celular:</label>
                <input type="text" name="celular" placeholder="Ingrese celular" value="{{ cliente.celular }}">
            </div>
            <div class="mb-2">
                <label>Recaudo:</label>
                <input type="text" name="recaudo" value="{{ '{:,.0f}'.format(cliente.recaudo|float) if cliente.recaudo else '' }}">
            </div>

            <div class="mb-2">
                <label>Tipo:</label>
                <select name="tipo">
                    <option value="No contesta" {% if cliente.tipo == "No contesta" %}selected{% endif %}>No contesta</option>
                    <option value="Ya pagó" {% if cliente.tipo == "Ya pagó" %}selected{% endif %}>Ya pagó</option>
                    <option value="Acuerdo de pago" {% if cliente.tipo == "Acuerdo de pago" %}selected{% endif %}>Acuerdo de pago</option>
                    <option value="Novedad" {% if cliente.tipo == "Novedad" %}selected{% endif %}>Novedad</option>
                    <option value="Se dejo msj con tercero" {% if cliente.tipo == "Se dejo msj con tercero" %}selected{% endif %}>Se dejó msj con tercero</option>
                    <option value="Se dejo mensaje con titular" {% if cliente.tipo == "Se dejo mensaje con titular" %}selected{% endif %}>Se dejó mensaje con titular</option>
                    <option value="Abono" {% if cliente.tipo == "Abono" %}selected{% endif %}>Abono</option>
                    <option value="Cliente no localizado" {% if cliente.tipo == "Cliente no localizado" %}selected{% endif %}>Cliente no localizado</option>
                    <option value="Contacto por whatsapp" {% if cliente.tipo == "Contacto por whatsapp" %}selected{% endif %}>Contacto por whatsapp</option>
                </select>
            </div>

            <div class="mb-2">
                <label>Asesor:</label>
                <input type="text" name="asesor" placeholder="Ingrese nombre de asesor" value="{{ cliente.asesor }}">
            </div>

            <div class="mb-3 observaciones-box">
                <label>Nueva observación:</label>
                <textarea name="observaciones" placeholder="Escribe una nueva observación aquí..."></textarea>
                <button type="button" id="btnHistorial" class="btn btn-success">Ver historial</button>
                <div id="historialBox" class="historial-box" style="display:none;">
                    <p><em>Haz clic en "ver historial" para cargar datos...</em></p>
                </div>
            </div>
        </div> <!-- Fin form-grid -->
    </form>

    <!-- Navegación entre clientes (ABAJO) -->
    <div class="navigation-buttons bottom-nav">
        {% if prev_id %}
            <a href="/cliente/{{ prev_id }}" class="btn">Regresar</a>
        {% endif %}
        {% if next_id %}
            <a href="/cliente/{{ next_id }}" class="btn">Siguiente</a>
        {% endif %}
    </div>

</div> <!-- Fin form-wrapper -->

<!-- Script de historial -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const btnHistorial = document.getElementById("btnHistorial");
    const box = document.getElementById("historialBox");

    if (btnHistorial) {
        btnHistorial.addEventListener("click", function () {
            fetch("/cliente/{{ cliente.id }}/historial")
                .then(response => {
                    if (!response.ok) throw new Error("Error en la respuesta del servidor");
                    return response.json();
                })
                .then(data => {
                    box.style.display = "block";
                    if (data.length > 0) {
                        box.innerHTML = "<ul>" + data.map(item =>
                            `<li>${item.fecha ?? ''} : ${item.texto}</li>`
                        ).join("") + "</ul>";
                    } else {
                        box.innerHTML = "<p><em>No hay historial disponible</em></p>";
                    }
                })
                .catch(err => {
                    console.error(err);
                    box.style.display = "block";
                    box.innerHTML = "<p style='color:red'>Error al cargar historial</p>";
                });
        });
    }
});
</script>
{% endblock %}
