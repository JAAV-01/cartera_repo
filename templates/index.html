{% extends "base.html" %}

{% block extra_css %}
<link href="/static/css/index.css" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="page-index">
  <div class="ix-wrap">
    <h1>Cartera</h1>

    <!-- Importación -->
    <div class="ix-card">
      <form action="/importar_excel" method="post" enctype="multipart/form-data">
        <div class="ix-grid">
          <div>
            <label>Archivo Cartera (.xlsx/.xls/.csv)</label>
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ix-btn ix-btn-green" type="submit">Importar</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Filtros -->
    <div class="ix-card">
      <form method="get" action="/">
        <div class="ix-grid">
          <div>
            <label for="view">Vista</label>
            <select id="view" name="view">
              <option value="flat" {{ 'selected' if view=='flat' else '' }}>Lista plana</option>
              <option value="group" {{ 'selected' if view=='group' else '' }}>Agrupado (acordeón)</option>
            </select>
          </div>
          <div>
            <label for="min_dias">Mín. días vencidos</label>
            <input id="min_dias" name="min_dias" type="number" min="0" value="{{ min_dias or '' }}">
          </div>
          <div>
            <label for="sort">Orden</label>
            <select id="sort" name="sort">
              <option value="dias_desc" {{ 'selected' if sort=='dias_desc' else '' }}>Días vencidos (desc)</option>
              <option value="dias_asc" {{ 'selected' if sort=='dias_asc' else '' }}>Días vencidos (asc)</option>
              <option value="razon_asc" {{ 'selected' if sort=='razon_asc' else '' }}>Razón social (A-Z)</option>
            </select>
          </div>
          <div>
            <label for="max_dias">Máx. días vencidos</label>
            <input id="max_dias" name="max_dias" type="number" min="0" value="{{ max_dias or '' }}">
          </div>
        </div>
        <div class="ix-row">
          <button class="ix-btn" type="submit">Aplicar</button>
          <a class="ix-btn" href="{{ request.url_for('exportar_cartera_xlsx') }}{% if request.query_params %}?{{ request.query_params }}{% endif %}">Exportar Excel</a>
        </div>
      </form>
    </div>

    <!-- Vista plana -->
    {% if view == 'flat' %}
    <div class="ix-card">
      <table class="ix-table">
        <thead>
          <tr>
            <th>Razón social</th>
            <th>NIT</th>
            <th>Factura</th>
            <th class="right">Días vencidos</th>
            <th>Fecha docto</th>
            <th>Fecha vcto</th>
            <th class="right">Valor docto</th>
            <th class="right">Total (COP)</th>
            <th class="right">Recaudo</th>
            <th>Asesor</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for f in filas %}
          <tr>
            <td>{{ f.razon_social or '-' }}</td>
            <td>{{ f.nit_cliente or '-' }}</td>
            <td class="mono">{{ f.nro_docto_cruce or '-' }}</td>
            <td class="right">{{ f.dias_vencidos if f.dias_vencidos is not none else '-' }}</td>
            <td>{{ f.fecha_docto or '-' }}</td>
            <td>{{ f.fecha_vcto or '-' }}</td>
            <td class="right mono">{{ f.valor_docto | fmt_money }}</td>
            <td class="right mono">{{ f.total_cop | fmt_money }}</td>
            <td class="right mono">{{ f.recaudo | fmt_money }}</td>
            <td>{{ f.asesor or '-' }}</td>
            <td class="right"><a class="ix-link" href="/cliente/{{ f.id }}">ver</a></td>
          </tr>
          {% else %}
          <tr>
            <td colspan="11" class="muted">Sin registros.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% else %}
    <!-- Vista agrupada -->
    {% if not clientes %}
      <div class="ix-card"><p class="muted">Sin clientes para los filtros.</p></div>
    {% else %}
      <div class="ix-accordion">
        {% for cl in clientes %}
        <details class="ix-details">
          <summary class="ix-summary">
            <div>
              <strong>{{ cl.razon_social or 'Sin razón social' }}</strong>
              <span class="muted"> · NIT: {{ cl.nit_cliente or 's/n' }}</span>
            </div>
            <div class="muted">Facturas: {{ cl.facturas|length }}</div>
            <div><span class="ix-badge">Máx. días: {{ cl.max_dias or '-' }}</span></div>
          </summary>
          <div class="ix-summary-body">
            <table class="ix-table">
              <thead>
                <tr>
                  <th>Factura</th>
                  <th class="right">Días vencidos</th>
                  <th>Fecha docto</th>
                  <th>Fecha vcto</th>
                  <th class="right">Valor docto</th>
                  <th class="right">Total (COP)</th>
                  <th class="right">Recaudo</th>
                  <th>Asesor</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for f in cl.facturas %}
                <tr>
                  <td class="mono">{{ f.nro_docto_cruce }}</td>
                  <td class="right">{{ f.dias_vencidos if f.dias_vencidos is not none else '-' }}</td>
                  <td>{{ f.fecha_docto or '-' }}</td>
                  <td>{{ f.fecha_vcto or '-' }}</td>
                  <td class="right mono">{{ f.valor_docto | fmt_money }}</td>
                  <td class="right mono">{{ f.total_cop | fmt_money }}</td>
                  <td class="right mono">{{ f.recaudo | fmt_money }}</td>
                  <td>{{ f.asesor or '-' }}</td>
                  <td class="right"><a class="ix-link" href="/cliente/{{ f.id }}">ver</a></td>
                </tr>
                {% endfor %}
                <!-- Fila de total -->
                  <tr class="ix-total-row">
                    <td colspan="5" class="right"><strong>Total cliente:</strong></td>
                    <td class="right mono"><strong>$ {{ cl.facturas | sum(attribute='total_cop') | fmt_money }}</strong></td>
                    <td colspan="3"></td>
                  </tr>
              </tbody>
            </table>
          </div>
        </details>
        {% endfor %}
      </div>
    {% endif %}
    {% endif %}
  </div>
</div>

{% endblock %}
